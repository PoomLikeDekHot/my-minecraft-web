<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Minecraft Manager: Ultimate Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Kanit", "sans-serif"], pixel: ['"Press Start 2P"', 'cursive'] },
          colors: { 
            mcDark: "#111111", 
            mcPanel: "rgba(30, 41, 59, 0.75)",
            accent: "#8b5cf6"
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'popup': 'popup 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
          },
          keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            popup: { '0%': { opacity: 0, transform: 'scale(0.9)' }, '100%': { opacity: 1, transform: 'scale(1)' } }
          }
        }
      }
    };
  </script>

  <style>
    :root { --accent-color: #8b5cf6; --glass-border: rgba(255, 255, 255, 0.1); }
    
    body {
      background-color: #050505;
      color: #e2e8f0;
      overflow-x: hidden;
      cursor: default; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô default ‡πÄ‡∏û‡∏∑‡πà‡∏≠ UX ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ custom cursor ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ */
    }

    /* Dynamic Background */
    #bg-layer {
      position: fixed; inset: 0; z-index: -2;
      background-image: url("https://assets.mcasset.cloud/1.21/assets/minecraft/textures/block/stone.png");
      background-size: 128px;
      filter: brightness(0.2);
      transition: all 1s ease;
    }
    #bg-gradient {
      position: fixed; inset: 0; z-index: -1;
      background: radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.15), transparent 70%);
      pointer-events: none;
    }

    /* Modern Glass Panel */
    .glass-morphism {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    .pixel-art { image-rendering: pixelated; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

    /* Custom Checkbox */
    .mc-checkbox { appearance: none; width: 20px; height: 20px; border: 2px solid #64748b; border-radius: 4px; display: grid; place-content: center; transition: 0.2s; cursor: pointer; }
    .mc-checkbox::before { content: ""; width: 10px; height: 10px; transform: scale(0); transition: 0.1s transform ease-in-out; box-shadow: inset 10px 10px var(--accent-color); transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
    .mc-checkbox:checked { border-color: var(--accent-color); background: rgba(139, 92, 246, 0.1); }
    .mc-checkbox:checked::before { transform: scale(1); }

    /* Achievement Toast */
    .achievement-toast {
      background: #232323;
      border: 2px solid #ffffff;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #ffff55;
      font-family: 'Press Start 2P', cursive; /* Minecraft Font */
      font-size: 10px;
      box-shadow: 0 0 0 2px #232323, 4px 4px 0 rgba(0,0,0,0.5);
      animation: slideDown 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards, fadeOut 0.5s 3s forwards;
      min-width: 280px;
    }
    @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }

    /* 3D Card Hover Effect */
    .card-3d { transition: transform 0.3s ease, box-shadow 0.3s ease; transform-style: preserve-3d; }
    .card-3d:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 20px 40px -5px rgba(0,0,0,0.4); border-color: var(--accent-color); }

    /* Stepper Button Animation */
    .stepper-btn:active { transform: scale(0.9); }
  </style>
</head>

<body class="min-h-screen font-sans">
  <div id="bg-layer"></div>
  <div id="bg-gradient"></div>

  <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

  <div class="p-4 md:p-6 max-w-7xl mx-auto transition-all duration-500" id="mainApp">
    
    <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 animate-popup">
      <div class="flex items-center gap-4">
        <div class="relative group">
          <div class="w-14 h-14 bg-slate-800 rounded-xl flex items-center justify-center border-2 border-slate-600 shadow-lg group-hover:border-[var(--accent-color)] transition-colors">
            <img src="https://assets.mcasset.cloud/1.21/assets/minecraft/textures/item/diamond_pickaxe.png" class="w-8 h-8 pixel-art animate-float">
          </div>
          <div class="absolute -bottom-1 -right-1 bg-emerald-500 text-black text-[10px] px-1.5 rounded font-bold">PRO</div>
        </div>
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-white drop-shadow-lg">MC <span class="text-[var(--accent-color)]">Manager</span></h1>
          <div class="flex items-center gap-2 text-xs text-slate-400 mt-1">
             <i class="fa-solid fa-server"></i> <span id="connectionStatus">Connected</span>
             <span class="w-1 h-1 bg-slate-600 rounded-full"></span>
             <span id="globalProgress">0% Completed</span>
          </div>
        </div>
      </div>

      <div class="flex gap-2 p-1.5 bg-slate-900/80 rounded-xl border border-slate-700 backdrop-blur-sm">
        <button onclick="changeBiome('overworld')" class="w-9 h-9 rounded-lg hover:bg-slate-700 flex items-center justify-center text-emerald-400 transition-all tooltip" title="Overworld"><i class="fa-solid fa-tree"></i></button>
        <button onclick="changeBiome('nether')" class="w-9 h-9 rounded-lg hover:bg-slate-700 flex items-center justify-center text-red-500 transition-all tooltip" title="Nether"><i class="fa-solid fa-fire"></i></button>
        <button onclick="changeBiome('end')" class="w-9 h-9 rounded-lg hover:bg-slate-700 flex items-center justify-center text-purple-400 transition-all tooltip" title="The End"><i class="fa-solid fa-eye"></i></button>
        <div class="w-px bg-slate-700 mx-1"></div>
        <button onclick="openModal('projectModal')" class="bg-[var(--accent-color)] text-white px-4 rounded-lg font-bold text-sm hover:brightness-110 shadow-lg shadow-purple-900/20 active:scale-95 transition-all">
          <i class="fa-solid fa-plus mr-1"></i> New
        </button>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 pb-20" id="projectList">
      </div>

    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-slate-500">
      <img src="https://assets.mcasset.cloud/1.21/assets/minecraft/textures/item/map.png" class="w-16 h-16 pixel-art opacity-50 mb-4 grayscale">
      <p>No projects found. Start building!</p>
    </div>
  </div>

  <div id="detailModal" class="fixed inset-0 z-50 hidden transition-all duration-300">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('detailModal')"></div>
    
    <div class="absolute inset-4 md:inset-10 bg-[#0f172a]/95 rounded-2xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden transform scale-95 opacity-0 transition-all duration-300 modal-content">
      
      <div class="h-16 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-900/50">
        <div class="flex items-center gap-4">
          <button onclick="closeModal('detailModal')" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 transition-colors">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <div class="h-8 w-px bg-slate-700"></div>
          <div>
            <h2 id="detailTitle" class="text-xl font-bold text-white leading-tight">Project Name</h2>
            <div class="flex items-center gap-2 text-[10px] text-slate-400">
              <span id="detailCat" class="uppercase tracking-wider">CATEGORY</span>
              <span>‚Ä¢</span>
              <span id="itemCountDisplay">0 Items</span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="toggleFocusMode()" id="focusBtn" class="p-2 rounded hover:bg-slate-700 text-slate-400 text-sm" title="Focus Mode"><i class="fa-solid fa-expand"></i></button>
            <button onclick="copyToClipboard()" class="p-2 rounded hover:bg-slate-700 text-slate-400 text-sm" title="Copy Summary"><i class="fa-brands fa-discord"></i></button>
            <div class="relative">
                <input type="text" id="searchItems" placeholder="Search items..." oninput="filterItems(this.value)" 
                       class="bg-slate-950 border border-slate-700 rounded-lg py-1.5 pl-8 pr-3 text-sm text-white focus:border-[var(--accent-color)] outline-none w-48 transition-all focus:w-64" />
                <i class="fa-solid fa-search absolute left-2.5 top-2 text-slate-500 text-xs"></i>
            </div>
        </div>
      </div>

      <div class="flex-1 overflow-hidden relative flex">
         <div class="w-64 border-r border-slate-700 bg-slate-900/30 flex flex-col hidden md:flex">
            <div class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Sticky Notes</div>
            <textarea id="projectNoteInput" onchange="saveNote()" class="flex-1 bg-transparent resize-none outline-none text-slate-300 text-sm p-3 placeholder-slate-600" placeholder="Type coordinates or notes here..."></textarea>
         </div>

         <div class="flex-1 overflow-y-auto p-4 md:p-6" id="itemsScrollArea">
            <div id="itemsContainer" class="space-y-3 max-w-4xl mx-auto"></div>
            <div class="h-24"></div> </div>
      </div>

      <div class="absolute bottom-0 left-0 right-0 bg-[#0f172a] border-t border-slate-700 p-4">
        <form onsubmit="event.preventDefault(); handleAddItem();" class="max-w-4xl mx-auto flex gap-3 items-center">
            <div class="relative flex-1 group">
                <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-cube text-slate-500"></i>
                </div>
                <input type="hidden" id="newItemId">
                <input type="text" id="newItemName" placeholder="Add new item... (e.g. Redstone)" 
                       class="w-full bg-slate-900 border border-slate-600 rounded-xl py-3 pl-10 pr-4 text-white focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)] outline-none transition-all"
                       oninput="searchGlobalItems(this.value)" autocomplete="off" />
                
                <div id="suggestionBox" class="absolute bottom-full left-0 right-0 mb-2 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-h-48 overflow-y-auto hidden z-20"></div>
            </div>

            <label class="cursor-pointer relative group">
                <input type="checkbox" id="newItemPriority" class="peer sr-only">
                <div class="w-11 h-11 rounded-xl bg-slate-900 border border-slate-600 flex items-center justify-center text-slate-500 peer-checked:text-red-400 peer-checked:border-red-500 peer-checked:bg-red-500/10 transition-all">
                    <i class="fa-solid fa-fire"></i>
                </div>
                <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black px-2 py-1 rounded text-[10px] opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">High Priority</span>
            </label>

            <button type="submit" class="w-12 h-11 bg-[var(--accent-color)] hover:bg-purple-500 text-white rounded-xl shadow-lg flex items-center justify-center transition-transform active:scale-95">
                <i class="fa-solid fa-plus text-lg"></i>
            </button>
        </form>
      </div>
    </div>
  </div>

  <div id="projectModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('projectModal')"></div>
    <div class="glass-morphism p-6 rounded-2xl w-full max-w-sm m-4 relative transform scale-95 opacity-0 transition-all modal-content">
        <h3 class="text-lg font-bold text-white mb-4">Create New Project</h3>
        <div class="space-y-4">
            <input type="text" id="newProjectName" placeholder="Project Name" class="w-full bg-slate-900/50 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-[var(--accent-color)]">
            
            <div class="grid grid-cols-3 gap-2">
                <button onclick="selectCategory('farm')" id="cat-btn-farm" class="cat-btn p-3 rounded-lg border border-slate-700 bg-slate-800 hover:bg-emerald-900/30 hover:border-emerald-500/50 flex flex-col items-center gap-2 transition-all">
                    <i class="fa-solid fa-wheat-awn text-emerald-400"></i> <span class="text-xs">Farm</span>
                </button>
                <button onclick="selectCategory('build')" id="cat-btn-build" class="cat-btn p-3 rounded-lg border border-slate-700 bg-slate-800 hover:bg-blue-900/30 hover:border-blue-500/50 flex flex-col items-center gap-2 transition-all active-cat">
                    <i class="fa-solid fa-hammer text-blue-400"></i> <span class="text-xs">Build</span>
                </button>
                <button onclick="selectCategory('redstone')" id="cat-btn-redstone" class="cat-btn p-3 rounded-lg border border-slate-700 bg-slate-800 hover:bg-red-900/30 hover:border-red-500/50 flex flex-col items-center gap-2 transition-all">
                    <i class="fa-solid fa-microchip text-red-400"></i> <span class="text-xs">Redstone</span>
                </button>
            </div>
            <input type="hidden" id="selectedCat" value="build">
            
            <button onclick="handleAddProject()" class="w-full bg-[var(--accent-color)] py-3 rounded-lg text-white font-bold shadow-lg hover:brightness-110 active:scale-95 transition-all">Create Project</button>
        </div>
    </div>
  </div>

  <input type="file" id="textureInput" class="hidden" accept="image/*" onchange="handleTextureUpload(this)" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, remove, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- Firebase Config (Your Keys) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAn2Pg3uFbIshFVpV1ysNprfIRdFMQ4ZWM",
      authDomain: "minecraft-deken-project.firebaseapp.com",
      databaseURL: "https://minecraft-deken-project-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "minecraft-deken-project"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- State Management ---
    let state = {
      projects: [],
      currentId: null,
      filterSearch: "",
      globalItems: [],
      isFocusMode: false
    };
    
    let textures = { server: {}, custom: JSON.parse(localStorage.getItem("mcCustomTextures") || "{}") };
    let textureUploadId = null;

    // --- Initialization ---
    // Fetch Items List for Auto-complete
    fetch("https://raw.githubusercontent.com/PrismarineJS/minecraft-data/master/data/pc/1.20/items.json")
      .then(r => r.json())
      .then(d => state.globalItems = d.map(i => ({ id: i.name, name: i.displayName })))
      .catch(() => console.log("Failed to load items"));

    // --- Render Logic ---
    onValue(ref(db, "projects"), (snapshot) => {
      const data = snapshot.val();
      state.projects = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })).reverse() : [];
      renderDashboard();
      if(state.currentId) renderItems();
    });

    onValue(ref(db, "textures"), (s) => { textures.server = s.val() || {}; if(state.currentId) renderItems(); });

    function renderDashboard() {
        const container = document.getElementById("projectList");
        const empty = document.getElementById("emptyState");
        
        if (state.projects.length === 0) {
            container.innerHTML = "";
            empty.classList.remove("hidden");
            empty.classList.add("flex");
            return;
        }
        empty.classList.add("hidden");
        empty.classList.remove("flex");

        // Calculate Global Progress
        let totalItems = 0;
        let totalDone = 0;

        const html = state.projects.map(p => {
            const items = p.items ? Object.values(p.items) : [];
            const done = items.filter(i => i.completed).length;
            const percent = items.length ? Math.round((done / items.length) * 100) : 0;
            
            totalItems += items.length;
            totalDone += done;

            // Icons & Colors
            const theme = p.category === 'farm' ? 'emerald' : p.category === 'redstone' ? 'red' : 'blue';
            const icon = p.category === 'farm' ? 'fa-wheat-awn' : p.category === 'redstone' ? 'fa-microchip' : 'fa-hammer';
            
            return `
            <div onclick="openProject('${p.id}')" class="glass-morphism rounded-xl p-5 cursor-pointer card-3d group relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-${theme}-500/10 rounded-full blur-2xl group-hover:bg-${theme}-500/20 transition-all"></div>
                
                <div class="flex justify-between items-start mb-4 relative z-10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-slate-800/80 border border-slate-700 flex items-center justify-center text-${theme}-400 shadow-inner">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-base truncate max-w-[140px]">${p.name}</h3>
                            <div class="text-[10px] text-slate-400 uppercase tracking-wide font-semibold">${p.category}</div>
                        </div>
                    </div>
                    <button onclick="deleteProject('${p.id}', event)" class="w-6 h-6 rounded flex items-center justify-center text-slate-600 hover:text-red-400 hover:bg-red-400/10 transition-colors opacity-0 group-hover:opacity-100">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                </div>

                <div class="space-y-1 relative z-10">
                    <div class="flex justify-between text-xs text-slate-300">
                        <span>Progress</span>
                        <span class="${percent === 100 ? 'text-green-400 font-bold' : ''}">${percent}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-${theme}-500 to-${theme}-400 transition-all duration-1000 ease-out" style="width: ${percent}%"></div>
                    </div>
                </div>
            </div>
            `;
        }).join('');

        container.innerHTML = html;
        document.getElementById("globalProgress").innerText = totalItems ? Math.round((totalDone/totalItems)*100) + "% Done" : "0% Done";
    }

    // --- Item Logic & The New UI ---
    window.renderItems = () => {
        const p = state.projects.find(x => x.id === state.currentId);
        if(!p) return;

        // Metadata Update
        document.getElementById("detailTitle").innerText = p.name;
        document.getElementById("detailCat").innerText = p.category;
        document.getElementById("projectNoteInput").value = p.notes || "";
        document.getElementById("itemCountDisplay").innerText = (p.items ? Object.keys(p.items).length : 0) + " Items";

        const container = document.getElementById("itemsContainer");
        const items = p.items ? Object.keys(p.items).map(k => ({id: k, ...p.items[k]})) : [];

        // Sorting: High Priority First, then Incomplete
        items.sort((a,b) => {
            if(a.priority === 'high' && b.priority !== 'high') return -1;
            if(a.priority !== 'high' && b.priority === 'high') return 1;
            return Number(a.completed) - Number(b.completed);
        });

        const filter = document.getElementById("searchItems").value.toLowerCase();
        
        container.innerHTML = items.filter(i => i.name.toLowerCase().includes(filter)).map(item => {
            const tex = textures.server[item.itemId] || textures.custom[item.itemId] || `https://assets.mcasset.cloud/1.21/assets/minecraft/textures/item/${item.itemId}.png`;
            const isDone = item.completed;
            const current = item.current || 0;
            const max = item.amount || 1;
            const percent = Math.min(100, Math.round((current/max)*100));

            // THE NEW UI ROW
            return `
            <div class="group relative flex items-center gap-4 bg-slate-800/40 border border-slate-700/50 hover:border-slate-500 rounded-xl p-3 transition-all ${isDone ? 'opacity-50 grayscale-[0.5]' : ''} ${item.priority==='high' ? 'border-l-4 border-l-red-500 bg-red-900/10' : ''}">
                
                <div class="flex items-center gap-3 pl-1">
                    <input type="checkbox" class="mc-checkbox" ${isDone ? 'checked' : ''} onchange="toggleItem('${item.id}', this.checked, ${max})">
                    <div class="w-10 h-10 bg-slate-900 rounded-lg flex items-center justify-center border border-slate-700 relative cursor-pointer hover:border-[var(--accent-color)]" onclick="uploadTex('${item.itemId}')">
                        <img src="${tex}" class="w-7 h-7 pixel-art object-contain" onerror="this.src='https://assets.mcasset.cloud/1.21/assets/minecraft/textures/item/barrier.png'">
                    </div>
                </div>

                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-medium text-slate-200 truncate ${isDone ? 'line-through text-slate-500' : ''}">${item.name}</span>
                        ${item.priority === 'high' ? '<i class="fa-solid fa-fire text-red-500 text-xs animate-pulse"></i>' : ''}
                    </div>
                    <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden border border-slate-700/50">
                        <div class="h-full bg-emerald-500 transition-all duration-300" style="width: ${percent}%"></div>
                    </div>
                </div>

                <div class="flex items-center bg-slate-950 rounded-lg border border-slate-700 p-0.5 select-none shadow-inner">
                    <button class="w-8 h-7 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 rounded stepper-btn transition-colors" 
                            onmousedown="adjustAmount('${item.id}', -1, ${current}, ${max})"><i class="fa-solid fa-minus text-xs"></i></button>
                    
                    <div class="w-12 text-center text-xs font-mono font-bold text-white cursor-text" onclick="promptAmount('${item.id}', ${max})">
                        <span class="${current >= max ? 'text-green-400' : 'text-slate-200'}">${current}</span><span class="text-slate-500">/${max}</span>
                    </div>

                    <button class="w-8 h-7 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 rounded stepper-btn transition-colors" 
                            onmousedown="adjustAmount('${item.id}', 1, ${current}, ${max})"><i class="fa-solid fa-plus text-xs"></i></button>
                </div>

                <button onclick="delItem('${item.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/20 text-slate-600 hover:text-red-400 transition-all opacity-0 group-hover:opacity-100">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            `;
        }).join('');
    };

    // --- Interactive Functions ---

    window.openProject = (id) => {
        state.currentId = id;
        renderItems();
        const m = document.getElementById("detailModal");
        m.classList.remove("hidden");
        setTimeout(() => {
            m.querySelector(".modal-content").classList.remove("scale-95", "opacity-0");
            m.querySelector(".modal-content").classList.add("scale-100", "opacity-100");
        }, 10);
    };

    window.closeModal = (id) => {
        const m = document.getElementById(id);
        m.querySelector(".modal-content").classList.remove("scale-100", "opacity-100");
        m.querySelector(".modal-content").classList.add("scale-95", "opacity-0");
        setTimeout(() => m.classList.add("hidden"), 300);
        if(id === 'detailModal') state.currentId = null;
    };

    // The Stepper Logic
    window.adjustAmount = (itemId, delta, current, max) => {
        const newVal = Math.max(0, Math.min(max, current + delta));
        const isComplete = newVal >= max;
        update(ref(db, `projects/${state.currentId}/items/${itemId}`), { 
            current: newVal, 
            completed: isComplete 
        });
        if(isComplete && delta > 0) showAchievement("Item Completed!", "emerald");
    };

    window.toggleItem = (id, isChecked, max) => {
        update(ref(db, `projects/${state.currentId}/items/${id}`), {
            completed: isChecked,
            current: isChecked ? max : 0
        });
        if(isChecked) {
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
            showAchievement("Task Done!", "gold");
        }
    };

    // Add Item Logic
    window.handleAddItem = () => {
        const name = document.getElementById("newItemName").value;
        const priority = document.getElementById("newItemPriority").checked ? "high" : "normal";
        const rawId = document.getElementById("newItemId").value;
        const itemId = rawId || name.toLowerCase().replace(/\s+/g, '_');
        
        if (!name || !state.currentId) return;

        // Default amount is 64 (1 stack) unless specified otherwise logic could be added
        push(ref(db, `projects/${state.currentId}/items`), {
            name: name,
            itemId: itemId,
            amount: 64, // Default Stack
            current: 0,
            completed: false,
            priority: priority
        });

        document.getElementById("newItemName").value = "";
        document.getElementById("newItemId").value = "";
        document.getElementById("newItemPriority").checked = false;
        document.getElementById("suggestionBox").classList.add("hidden");
        
        // Scroll to bottom
        setTimeout(() => {
             const scrollArea = document.getElementById("itemsScrollArea");
             scrollArea.scrollTo({ top: scrollArea.scrollHeight, behavior: 'smooth' });
        }, 200);
    };

    // Prompt for manual number entry
    window.promptAmount = (itemId, max) => {
        const val = prompt(`Set amount (Max: ${max}):`);
        if(val !== null) {
            const num = parseInt(val);
            if(!isNaN(num)) window.adjustAmount(itemId, num - (parseInt(val)||0) /* tricky hack but simple update works */, 0, max);
            update(ref(db, `projects/${state.currentId}/items/${itemId}`), { current: Math.min(max, Math.max(0, num)), completed: num >= max });
        }
    };

    // Feature: Copy Summary for Discord
    window.copyToClipboard = () => {
        const p = state.projects.find(x => x.id === state.currentId);
        if(!p) return;
        const items = Object.values(p.items || {});
        const todo = items.filter(i => !i.completed);
        
        let text = `**üî® Project: ${p.name}**\n`;
        text += `Progress: ${Math.round(((items.length-todo.length)/items.length)*100)}%\n\n`;
        text += `**To Collect:**\n`;
        todo.forEach(i => {
            text += `‚Ä¢ ${i.name}: ${i.current}/${i.amount}\n`;
        });
        
        navigator.clipboard.writeText(text);
        showAchievement("Copied to Clipboard!", "blue");
    };

    // Feature: Focus Mode
    window.toggleFocusMode = () => {
        state.isFocusMode = !state.isFocusMode;
        const m = document.getElementById("detailModal").querySelector(".modal-content");
        if(state.isFocusMode) {
            m.classList.add("fixed", "inset-0", "z-[100]", "rounded-none");
            m.classList.remove("rounded-2xl", "m-4", "border");
            document.getElementById("focusBtn").innerHTML = '<i class="fa-solid fa-compress"></i>';
        } else {
            m.classList.remove("fixed", "inset-0", "z-[100]", "rounded-none");
            m.classList.add("rounded-2xl", "border");
            document.getElementById("focusBtn").innerHTML = '<i class="fa-solid fa-expand"></i>';
        }
    };

    // Toast Notification System
    window.showAchievement = (text, color) => {
        const t = document.createElement("div");
        t.className = "achievement-toast";
        
        let icon = "fa-trophy";
        if(color === 'emerald') icon = "fa-check";
        if(color === 'blue') icon = "fa-clipboard";

        t.innerHTML = `
            <div class="w-8 h-8 bg-slate-800 border-2 border-white flex items-center justify-center">
                <i class="fa-solid ${icon} text-${color}-400"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-xs text-yellow-200 mb-0.5">Achievement Get!</span>
                <span>${text}</span>
            </div>
        `;
        document.getElementById("toast-container").appendChild(t);
        setTimeout(() => t.remove(), 4000);
    };

    // Helpers
    window.delItem = (id) => { if(confirm("Remove item?")) remove(ref(db, `projects/${state.currentId}/items/${id}`)); };
    window.deleteProject = (id, e) => { e.stopPropagation(); if(confirm("Delete Project?")) remove(ref(db, `projects/${id}`)); };
    window.saveNote = () => update(ref(db, `projects/${state.currentId}`), { notes: document.getElementById("projectNoteInput").value });
    
    // Search Autocomplete
    window.searchGlobalItems = (val) => {
        const box = document.getElementById("suggestionBox");
        if(val.length < 2) { box.classList.add("hidden"); return; }
        
        const matches = state.globalItems.filter(i => i.name.toLowerCase().includes(val.toLowerCase())).slice(0, 10);
        if(matches.length > 0) {
            box.innerHTML = matches.map(i => `
                <div class="flex items-center gap-2 p-2 hover:bg-slate-700 cursor-pointer text-sm text-slate-300 transition-colors"
                     onclick="selectSuggestion('${i.name}', '${i.id}')">
                    <img src="https://assets.mcasset.cloud/1.21/assets/minecraft/textures/item/${i.id}.png" class="w-5 h-5 pixel-art">
                    ${i.name}
                </div>
            `).join('');
            box.classList.remove("hidden");
        } else {
            box.classList.add("hidden");
        }
    };

    window.selectSuggestion = (name, id) => {
        document.getElementById("newItemName").value = name;
        document.getElementById("newItemId").value = id;
        document.getElementById("suggestionBox").classList.add("hidden");
    };

    // UI Toggles
    window.selectCategory = (cat) => {
        document.querySelectorAll(".cat-btn").forEach(b => b.classList.remove("border-[var(--accent-color)]", "bg-slate-700"));
        document.getElementById("cat-btn-"+cat).classList.add("border-[var(--accent-color)]", "bg-slate-700");
        document.getElementById("selectedCat").value = cat;
    };
    
    window.handleAddProject = () => {
        const name = document.getElementById("newProjectName").value;
        const cat = document.getElementById("selectedCat").value;
        if(name) {
            push(ref(db, "projects"), { name, category: cat, items: {} });
            closeModal("projectModal");
            document.getElementById("newProjectName").value = "";
            showAchievement("New Journey!", "gold");
        }
    };

    window.changeBiome = (b) => {
        const bg = document.getElementById("bg-layer");
        const root = document.documentElement;
        if(b === 'nether') {
            bg.style.backgroundImage = 'url("https://assets.mcasset.cloud/1.21/assets/minecraft/textures/block/netherrack.png")';
            bg.style.filter = "brightness(0.3) sepia(0.5) hue-rotate(-50deg)";
            root.style.setProperty('--accent-color', '#ef4444');
        } else if(b === 'end') {
            bg.style.backgroundImage = 'url("https://assets.mcasset.cloud/1.21/assets/minecraft/textures/block/end_stone.png")';
            bg.style.filter = "brightness(0.2) hue-rotate(240deg)";
            root.style.setProperty('--accent-color', '#d946ef');
        } else {
            bg.style.backgroundImage = 'url("https://assets.mcasset.cloud/1.21/assets/minecraft/textures/block/stone.png")';
            bg.style.filter = "brightness(0.2)";
            root.style.setProperty('--accent-color', '#8b5cf6');
        }
    };
    
    // Texture Upload
    window.uploadTex = (id) => { textureUploadId = id; document.getElementById("textureInput").click(); };
    window.handleTextureUpload = (el) => {
        const f = el.files[0];
        if(f) {
            const r = new FileReader();
            r.onload = (e) => set(ref(db, "textures/" + textureUploadId), e.target.result);
            r.readAsDataURL(f);
        }
        el.value = '';
    };

    // Filter Items in Modal
    window.filterItems = (v) => renderItems();
  </script>
</body>
</html>
